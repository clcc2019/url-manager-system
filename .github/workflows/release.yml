name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # æ„å»ºç”Ÿäº§ç‰ˆæœ¬é•œåƒ
    - name: Build and push backend release image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./backend/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.ref_name }}
          ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:stable
        labels: |
          org.opencontainers.image.title=URL Manager Backend
          org.opencontainers.image.description=Backend service for URL Manager System
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push frontend release image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./frontend/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.ref_name }}
          ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:stable
        labels: |
          org.opencontainers.image.title=URL Manager Frontend
          org.opencontainers.image.description=Frontend application for URL Manager System
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # ç”Ÿæˆæ›´æ–°æ—¥å¿—
    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "changelog=é¦–æ¬¡å‘å¸ƒ" >> $GITHUB_OUTPUT
        else
          # ç”Ÿæˆæ›´æ–°æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          # è½¬ä¹‰æ¢è¡Œç¬¦
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "changelog=${CHANGELOG}" >> $GITHUB_OUTPUT
        fi

    # åˆ›å»ºGitHub Release
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ URL Manager System ${{ github.ref_name }}

          ### ğŸ“¦ Dockeré•œåƒ
          
          **åç«¯æœåŠ¡:**
          ```bash
          docker pull ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}
          ```
          
          **å‰ç«¯åº”ç”¨:**
          ```bash
          docker pull ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}
          ```

          ### ğŸš€ å¿«é€Ÿéƒ¨ç½²

          **ä½¿ç”¨Helméƒ¨ç½²:**
          ```bash
          helm upgrade --install url-manager ./deployments/helm/url-manager \
            --namespace url-manager \
            --create-namespace \
            --set backend.image.repository=ghcr.io/${{ github.repository }}/backend \
            --set backend.image.tag=${{ github.ref_name }} \
            --set frontend.image.repository=ghcr.io/${{ github.repository }}/frontend \
            --set frontend.image.tag=${{ github.ref_name }}
          ```

          **ä½¿ç”¨Docker Compose:**
          ```bash
          export BACKEND_IMAGE=ghcr.io/${{ github.repository }}/backend:${{ github.ref_name }}
          export FRONTEND_IMAGE=ghcr.io/${{ github.repository }}/frontend:${{ github.ref_name }}
          docker-compose -f deployments/docker/docker-compose.yml up -d
          ```

          ### ğŸ“‹ æ›´æ–°å†…å®¹
          
          ${{ steps.changelog.outputs.changelog }}

          ### ğŸ”’ å®‰å…¨ä¿¡æ¯
          
          æ‰€æœ‰é•œåƒéƒ½ç»è¿‡äº†å®‰å…¨æ‰«æï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚

          ### ğŸ“š æ–‡æ¡£
          
          - [APIæ–‡æ¡£](./docs/api.md)
          - [éƒ¨ç½²æŒ‡å—](./docs/deployment.md)
          - [é¡¹ç›®ç»“æ„](./docs/project-structure.md)

        draft: false
        prerelease: false
        files: |
          deployments/helm/url-manager-*.tgz
        generate_release_notes: true